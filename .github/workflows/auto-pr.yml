name: Auto PR

on:
  push:
    branches-ignore:
      - main
      - develop

jobs:
  auto-pr:
    if: ${{ !contains(github.event.head_commit.message, 'Merge pull request') }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for existing PR
        id: check-pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          existing_pr=$(gh pr list --head ${{ github.ref_name }} --base develop --json number --jq '.[0].number')
          if [ -n "$existing_pr" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "PR already exists: #$existing_pr"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate PR Content
        if: steps.check-pr.outputs.exists == 'false'
        id: generate-pr
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          chmod +x .github/scripts/generate-pr-description.sh
          bash .github/scripts/generate-pr-description.sh develop ${{ github.ref_name }}

      - name: Create Pull Request
        if: steps.check-pr.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ secrets.ADD_TO_PROJECT_PAT || secrets.GITHUB_TOKEN }}
          PR_TITLE: ${{ steps.generate-pr.outputs.title }}
          PR_BODY: ${{ steps.generate-pr.outputs.body }}
        run: |
          echo "$PR_BODY" > pr_body.md
          echo "" >> pr_body.md
          echo "---" >> pr_body.md
          echo "_Gemini로 자동 생성된 PR입니다._" >> pr_body.md
          
          gh pr create \
            --base develop \
            --head ${{ github.ref_name }} \
            --title "$PR_TITLE" \
            --assignee "${{ github.actor }}" \
            --body-file pr_body.md
